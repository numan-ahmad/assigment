{"version":3,"file":"BaseElement.js","sources":["../../../../../src/components/internal/BaseElement/BaseElement.ts"],"sourcesContent":["import { ComponentChild, h, render } from 'preact';\nimport getProp from '../../../utils/getProp';\nimport uuid from '../../../utils/uuid';\nimport AdyenCheckoutError from '../../../core/Errors/AdyenCheckoutError';\nimport { ANALYTICS_RENDERED_STR, NO_CHECKOUT_ATTEMPT_ID } from '../../../core/Analytics/constants';\n\nimport type { ICore } from '../../../core/types';\nimport type { BaseElementProps, IBaseElement } from './types';\nimport type { PaymentData } from '../../../types/global-types';\nimport type { AnalyticsInitialEvent, SendAnalyticsObject } from '../../../core/Analytics/types';\nimport { off, on } from '../../../utils/listenerUtils';\n\n/**\n * Verify if the first parameter is instance of Core.\n * We do not use 'instanceof' to avoid importing the Core class directly into this class.\n * @param checkout\n */\nfunction assertIsCoreInstance(checkout: ICore): checkout is ICore {\n    if (!checkout) return false;\n    const isCoreObject = typeof checkout.initialize === 'function' && typeof checkout.createFromAction === 'function';\n    return isCoreObject;\n}\n\nabstract class BaseElement<P extends BaseElementProps> implements IBaseElement {\n    public readonly _id = `${this.constructor['type']}-${uuid()}`;\n    public readonly core: ICore;\n\n    public props: P;\n    public state: any = {};\n    public _component;\n\n    protected _node: HTMLElement = null;\n\n    protected static defaultProps = {};\n\n    constructor(checkout: ICore, props?: P) {\n        const isCoreInstance = assertIsCoreInstance(checkout);\n\n        if (!isCoreInstance) {\n            throw new AdyenCheckoutError(\n                'IMPLEMENTATION_ERROR',\n                `Trying to initialise the component '${this.constructor['type']}' without a reference to an instance of AdyenCheckout`\n            );\n        }\n\n        this.core = checkout;\n        this.buildElementProps(props);\n\n        this.handleKeyPress = this.handleKeyPress.bind(this);\n    }\n\n    protected buildElementProps(componentProps?: P) {\n        this.props = this.formatProps({ ...this.constructor['defaultProps'], ...componentProps });\n    }\n\n    /**\n     * Executed during creation of any payment element.\n     * Gives a chance to any paymentMethod to format the props we're receiving.\n     */\n    protected formatProps(props: P) {\n        return props;\n    }\n\n    /**\n     * Executed on the `data` getter.\n     * Returns the component data necessary for the /payments request\n     */\n    protected formatData(): any {\n        return {};\n    }\n\n    /* eslint-disable-next-line */\n    protected setUpAnalytics(setUpAnalyticsObj: AnalyticsInitialEvent) {\n        return null;\n    }\n\n    /* eslint-disable-next-line */\n    protected submitAnalytics(analyticsObj?: SendAnalyticsObject) {\n        return null;\n    }\n\n    /* eslint-disable-next-line */\n    protected handleKeyPress(e: h.JSX.TargetedKeyboardEvent<HTMLInputElement>) {\n        return null;\n    }\n\n    protected setState(newState: object): void {\n        this.state = { ...this.state, ...newState };\n    }\n\n    /**\n     * Returns the component payment data ready to submit to the Checkout API\n     * Note: this does not ensure validity, check isValid first\n     */\n    public get data(): PaymentData {\n        const clientData = getProp(this.props, 'modules.risk.data');\n        const checkoutAttemptId = getProp(this.props, 'modules.analytics.getCheckoutAttemptId')?.() ?? NO_CHECKOUT_ATTEMPT_ID; // NOTE: we never expect to see this \"failed\" value, but, just in case...\n        const order = this.state.order || this.props.order;\n        const componentData = this.formatData();\n\n        if (componentData.paymentMethod && checkoutAttemptId) {\n            componentData.paymentMethod.checkoutAttemptId = checkoutAttemptId;\n        }\n\n        // Workaround, to be fixed properly\n        // Remove the firstName & lastName in the billingAddress for non Riverty components\n        // @ts-ignore type exists\n        if (this.props.type !== 'riverty' && componentData.billingAddress) {\n            const { firstName, lastName, ...rest } = componentData.billingAddress;\n            componentData.billingAddress = { ...rest };\n        }\n\n        return {\n            ...(clientData && { riskData: { clientData } }),\n            ...(order && { order: { orderData: order.orderData, pspReference: order.pspReference } }),\n            ...componentData,\n            clientStateDataIndicator: true\n        };\n    }\n\n    /**\n     * Method used to make the payment method active\n     * (Useful when there are different payment methods available and activating one PM must trigger a specific task)\n     */\n    public activate(): void {\n        return;\n    }\n\n    public render(): ComponentChild | Error {\n        // render() not implemented in the element\n        throw new Error('Payment method cannot be rendered.');\n    }\n\n    /**\n     * Mounts an element into the dom\n     * @param domNode - Node (or selector) where we will mount the payment element\n     * @returns this - the payment element instance we mounted\n     */\n    public mount(domNode: HTMLElement | string): this {\n        const node = typeof domNode === 'string' ? document.querySelector<HTMLElement>(domNode) : domNode;\n\n        if (!node) {\n            throw new Error('Component could not mount. Root node was not found.');\n        }\n\n        const setupAnalytics = !this._node;\n\n        if (this._node) {\n            this.unmount(); // new, if this._node exists then we are \"remounting\" so we first need to unmount if it's not already been done\n        }\n\n        this._node = node;\n\n        // Add listener for key press events, notably 'Enter' key presses\n        on(this._node, 'keypress', this.handleKeyPress, false);\n\n        this._component = this.render();\n\n        render(this._component, node);\n\n        // Set up analytics (once, since this._node is currently undefined) now that we have mounted and rendered\n        if (setupAnalytics) {\n            if (this.props.modules && this.props.modules.analytics) {\n                this.setUpAnalytics({\n                    containerWidth: node && node.offsetWidth,\n                    component: !this.props.isDropin ? (this.constructor['analyticsType'] ?? this.constructor['type']) : 'dropin',\n                    flavor: !this.props.isDropin ? 'components' : 'dropin'\n                }).then(() => {\n                    // Once the initial analytics set up call has been made...\n                    // ...create an analytics event  declaring that the component has been rendered\n                    // (The dropin will do this itself from DropinComponent once the PM list has rendered)\n                    if (!this.props.isDropin) {\n                        this.submitAnalytics({ type: ANALYTICS_RENDERED_STR });\n                    }\n                });\n            }\n        }\n\n        return this;\n    }\n\n    /**\n     * Updates props, resets the internal state and remounts the element.\n     *\n     * @param props - props to update\n     * @returns this - the element instance\n     */\n    public update(props: Partial<P>): this {\n        this.props = this.formatProps({ ...this.props, ...props });\n        this.state = {};\n\n        return this.unmount().mount(this._node); // for new mount fny\n    }\n\n    /**\n     * Unmounts a payment element from the DOM\n     */\n    public unmount(): this {\n        // Remove listener\n        off(this._node, 'keypress', this.handleKeyPress);\n\n        if (this._node) {\n            render(null, this._node);\n        }\n\n        return this;\n    }\n\n    /**\n     * Unmounts an element and removes it from the parent instance\n     * For \"destroy\" type cleanup - when you don't intend to use the component again\n     */\n    public remove() {\n        this.unmount();\n\n        if (this.core) {\n            this.core.remove(this);\n        }\n    }\n}\n\nexport default BaseElement;\n"],"names":["BaseElement","buildElementProps","componentProps","this","props","formatProps","_object_spread","constructor","formatData","setUpAnalytics","setUpAnalyticsObj","submitAnalytics","analyticsObj","handleKeyPress","e","setState","newState","state","data","getProp","clientData","checkoutAttemptId","NO_CHECKOUT_ATTEMPT_ID","order","componentData","paymentMethod","type","billingAddress","rest","firstName","lastName","_object_spread_props","riskData","orderData","pspReference","clientStateDataIndicator","activate","render","Error","mount","domNode","node","document","querySelector","setupAnalytics","_node","_this_constructor_analyticsType","unmount","on","_component","modules","analytics","containerWidth","offsetWidth","component","isDropin","flavor","then","ANALYTICS_RENDERED_STR","update","off","remove","core","checkout","_define_property","_id","uuid","isCoreInstance","initialize","createFromAction","assertIsCoreInstance","AdyenCheckoutError","bind","defaultProps"],"mappings":"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"}