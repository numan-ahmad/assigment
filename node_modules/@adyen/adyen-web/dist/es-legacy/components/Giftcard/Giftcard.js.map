{"version":3,"file":"Giftcard.js","sources":["../../../../src/components/Giftcard/Giftcard.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport GiftcardComponent from './components/GiftcardComponent';\nimport { CoreProvider } from '../../core/Context/CoreProvider';\nimport PayButton from '../internal/PayButton';\nimport AdyenCheckoutError from '../../core/Errors/AdyenCheckoutError';\nimport { PaymentAmount } from '../../types/global-types';\nimport { GiftCardElementData, GiftCardConfiguration, balanceCheckResponseType } from './types';\nimport { TxVariants } from '../tx-variants';\n\nexport class GiftcardElement extends UIElement<GiftCardConfiguration> {\n    public static type = TxVariants.giftcard;\n\n    protected static defaultProps = {\n        brandsConfiguration: {}\n    };\n\n    formatProps(props) {\n        return {\n            ...props?.configuration,\n            ...props\n        };\n    }\n\n    formatData(): GiftCardElementData {\n        return {\n            paymentMethod: {\n                type: this.constructor['type'],\n                brand: this.props.brand,\n                encryptedCardNumber: this.state.data?.encryptedCardNumber,\n                encryptedSecurityCode: this.state.data?.encryptedSecurityCode\n            }\n        };\n    }\n\n    get isValid() {\n        return !!this.state.isValid;\n    }\n\n    get icon() {\n        return this.props.brandsConfiguration[this.props.brand]?.icon || this.props.icon || this.resources.getImage()(this.props.brand);\n    }\n\n    get displayName() {\n        return this.props.brandsConfiguration[this.props.brand]?.name || this.props.name;\n    }\n\n    private handleBalanceCheck = (data: GiftCardElementData): Promise<balanceCheckResponseType> => {\n        if (this.props.onBalanceCheck) {\n            return new Promise((resolve, reject) => {\n                void this.props.onBalanceCheck(resolve, reject, data);\n            });\n        }\n\n        if (this.props.session) {\n            return this.props.session.checkBalance(data);\n        }\n    };\n\n    private onOrderRequest = data => {\n        if (this.props.onOrderRequest)\n            return new Promise((resolve, reject) => {\n                void this.props.onOrderRequest(resolve, reject, data);\n            });\n\n        if (this.props.session) {\n            return this.props.session.createOrder();\n        }\n    };\n\n    public balanceCheck() {\n        return this.onBalanceCheck();\n    }\n\n    private onBalanceCheck = (): void => {\n        // skip balance check if no onBalanceCheck event has been defined\n        const hasBalanceCheck = this.props.session || this.props.onBalanceCheck;\n        if (!hasBalanceCheck) return super.submit();\n\n        this.setStatus('loading');\n\n        this.handleBalanceCheck(this.formatData())\n            .then(({ balance, transactionLimit = {} as PaymentAmount }) => {\n                if (!balance) throw new Error('card-error'); // card doesn't exist\n                if (balance?.currency !== this.props.amount?.currency) throw new Error('currency-error');\n                if (balance?.value <= 0) throw new Error('no-balance');\n\n                this.componentRef.setBalance({ balance, transactionLimit });\n\n                if (this.props.amount.value > balance.value || this.props.amount.value > transactionLimit.value) {\n                    if (this.props.order) {\n                        return super.submit();\n                    }\n\n                    return this.onOrderRequest(this.data).then((order: { orderData: string; pspReference: string }) => {\n                        this.setState({ order: { orderData: order.orderData, pspReference: order.pspReference } });\n                        return super.submit();\n                    });\n                } else {\n                    return this.handleOnRequiringConfirmation().then(() => super.submit());\n                }\n            })\n            .catch(error => {\n                this.setStatus(error?.message || 'error');\n                if (this.props.onError) this.handleError(new AdyenCheckoutError('ERROR', error));\n            });\n    };\n\n    private handleOnRequiringConfirmation = (): Promise<any> => {\n        if (this.props.onRequiringConfirmation) {\n            return new Promise<void>((resolve, reject) => {\n                void this.props.onRequiringConfirmation(resolve, reject);\n            });\n        }\n    };\n\n    public submit() {\n        if (!this.isValid) {\n            this.showValidation();\n            return false;\n        }\n\n        this.balanceCheck();\n    }\n\n    // Giftcards override the regular payButton flow\n    public payButton = props => {\n        return <PayButton {...props} />;\n    };\n\n    render() {\n        return (\n            <CoreProvider i18n={this.props.i18n} loadingContext={this.props.loadingContext} resources={this.resources}>\n                <GiftcardComponent\n                    ref={ref => {\n                        this.componentRef = ref;\n                    }}\n                    {...this.props}\n                    handleKeyPress={this.handleKeyPress}\n                    showPayButton={this.props.showPayButton}\n                    onChange={this.setState}\n                    onBalanceCheck={this.onBalanceCheck}\n                    onSubmit={this.submit}\n                    payButton={this.payButton}\n                />\n            </CoreProvider>\n        );\n    }\n}\n\nexport default GiftcardElement;\n"],"names":["GiftcardElement","UIElement","formatProps","props","_object_spread","configuration","formatData","_this_state_data","_this_state_data1","paymentMethod","type","this","constructor","brand","encryptedCardNumber","state","data","encryptedSecurityCode","isValid","icon","_this_props_brandsConfiguration_this_props_brand","brandsConfiguration","resources","getImage","displayName","name","balanceCheck","onBalanceCheck","submit","showValidation","render","h","CoreProvider","i18n","loadingContext","GiftcardComponent","ref","componentRef","handleKeyPress","showPayButton","onChange","setState","onSubmit","payButton","super","args","_define_property","handleBalanceCheck","Promise","resolve","reject","session","checkBalance","onOrderRequest","createOrder","setStatus","then","balance","transactionLimit","_this_props_amount","Error","currency","amount","value","setBalance","order","orderData","pspReference","handleOnRequiringConfirmation","catch","error","message","onError","handleError","AdyenCheckoutError","onRequiringConfirmation","PayButton","TxVariants","giftcard","defaultProps"],"mappings":"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"}