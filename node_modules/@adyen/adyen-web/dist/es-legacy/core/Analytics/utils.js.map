{"version":3,"file":"utils.js","sources":["../../../../src/core/Analytics/utils.ts"],"sourcesContent":["import { AnalyticsObject, CreateAnalyticsObject, CardConfigData, AnalyticsData } from './types';\nimport { ANALYTICS_ACTION_STR, ANALYTICS_VALIDATION_ERROR_STR, errorCodeMapping, ALLOWED_ANALYTICS_DATA } from './constants';\nimport uuid from '../../utils/uuid';\nimport { digitsOnlyFormatter } from '../../utils/Formatters/formatters';\nimport { ERROR_FIELD_REQUIRED, ERROR_INVALID_FORMAT_EXPECTS } from '../Errors/constants';\nimport { DEFAULT_CHALLENGE_WINDOW_SIZE, THREEDS2_FULL } from '../../components/ThreeDS2/constants';\nimport { CardConfiguration } from '../../components/Card/types';\nimport CardInputDefaultProps from '../../components/Card/components/CardInput/defaultProps';\nimport { DEFAULT_CARD_GROUP_TYPES } from '../../components/internal/SecuredFields/lib/constants';\nimport { notFalsy } from '../../utils/commonUtils';\n\nconst MAX_LENGTH = 128;\nexport const getUTCTimestamp = () => Date.now();\n\n/**\n * All objects for the /checkoutanalytics endpoint have base props:\n *  \"timestamp\" & \"component\"\n *\n * Error objects have, in addition to the base props:\n *  \"code\", \"errorType\" & \"message\"\n *\n * Log objects have, in addition to the base props:\n *  \"message\" & \"type\" &\n *    \"subtype\" (e.g. when an action is handled)\n *\n * Info objects have, in addition to the base props:\n *   \"type\" & \"target\" &\n *     \"isStoredPaymentMethod\" & \"brand\" (when a storedCard is \"selected\"), or,\n *     \"validationErrorCode\" & \"validationErrorMessage\" (when the event is describing a validation error)\n *\n *  All objects can also have a \"metadata\" object of key-value pairs\n */\nexport const createAnalyticsObject = (aObj: CreateAnalyticsObject): AnalyticsObject => ({\n    timestamp: String(getUTCTimestamp()),\n    component: aObj.component,\n    id: uuid(),\n    /** ERROR */\n    ...(aObj.event === 'error' && { code: aObj.code, errorType: aObj.errorType, message: aObj.message }), // error event\n    /** LOG */\n    ...(aObj.event === 'log' && { type: aObj.type, message: aObj.message }), // log event\n    ...(aObj.event === 'log' && (aObj.type === ANALYTICS_ACTION_STR || aObj.type === THREEDS2_FULL) && { subType: aObj.subtype }), // only added if we have a log event of Action type or ThreeDS2\n    ...(aObj.event === 'log' && aObj.type === THREEDS2_FULL && { result: aObj.result }), // only added if we have a log event of ThreeDS2 type\n    /** INFO */\n    ...(aObj.event === 'info' && { type: aObj.type, target: aObj.target }), // info event\n    ...(aObj.event === 'info' && aObj.issuer && { issuer: aObj.issuer }), // relates to issuerLists\n    ...(aObj.event === 'info' && { isExpress: aObj.isExpress, expressPage: aObj.expressPage }), // relates to Plugins & detecting Express PMs\n    ...(aObj.event === 'info' && aObj.isStoredPaymentMethod && { isStoredPaymentMethod: aObj.isStoredPaymentMethod, brand: aObj.brand }), // only added if we have an info event about a storedPM\n    ...(aObj.event === 'info' &&\n        aObj.type === ANALYTICS_VALIDATION_ERROR_STR && {\n            validationErrorCode: mapErrorCodesForAnalytics(aObj.validationErrorCode, aObj.target),\n            validationErrorMessage: aObj.validationErrorMessage\n        }), // only added if we have an info event describing a validation error\n    ...(aObj.configData && { configData: aObj.configData }),\n    /** All */\n    ...(aObj.metadata && { metadata: aObj.metadata })\n});\n\nconst mapErrorCodesForAnalytics = (errorCode: string, target: string) => {\n    // Some of the more generic error codes required combination with target to retrieve a specific code\n    if (errorCode === ERROR_FIELD_REQUIRED || errorCode === ERROR_INVALID_FORMAT_EXPECTS) {\n        return errorCodeMapping[`${errorCode}.${target}`] ?? errorCode;\n    }\n\n    let errCode = errorCodeMapping[errorCode] ?? errorCode;\n\n    // If errCode isn't now a number - then we just need to remove any non-digits\n    // since the correct error code is already contained within the string e.g. securedField related errors\n    if (isNaN(Number(errCode))) {\n        errCode = digitsOnlyFormatter(errCode);\n    }\n\n    return errCode;\n};\n\nexport const processAnalyticsData = (analyticsData: AnalyticsData): AnalyticsData => {\n    return Object.keys(analyticsData).reduce((acc, prop) => {\n        if (ALLOWED_ANALYTICS_DATA.includes(prop)) acc[prop] = analyticsData[prop];\n        return acc;\n    }, {});\n};\n\nexport const getCardConfigData = (cardProps: CardConfiguration): CardConfigData => {\n    // Extract props from cardProps - mostly setting a default value, if prop not found\n    const {\n        autoFocus,\n        billingAddressAllowedCountries,\n        billingAddressMode,\n        billingAddressRequired,\n        billingAddressRequiredFields,\n        brands = DEFAULT_CARD_GROUP_TYPES,\n        brandsConfiguration,\n        challengeWindowSize = DEFAULT_CHALLENGE_WINDOW_SIZE,\n        configuration,\n        countryCode,\n        data,\n        disclaimerMessage,\n        disableIOSArrowKeys,\n        doBinLookup,\n        enableStoreDetails,\n        exposeExpiryDate,\n        forceCompat,\n        hasHolderName,\n        hideCVC,\n        holderNameRequired,\n        installmentOptions,\n        keypadFix,\n        legacyInputMode,\n        maskSecurityCode,\n        minimumExpiryDate,\n        name, // = 'none',\n        placeholders,\n        positionHolderNameOnTop,\n        showBrandIcon,\n        showInstallmentAmounts,\n        showPayButton = false, // hard coded default\n        styles,\n        onAllValid,\n        onBinLookup,\n        onBinValue,\n        onBlur,\n        onBrand,\n        onConfigSuccess,\n        onEnterKeyPressed,\n        onFieldValid,\n        onFocus,\n        onLoad\n    } = cardProps;\n\n    const dataString = JSON.stringify(CardInputDefaultProps.data);\n\n    const srPanelEnabled = cardProps.modules?.srPanel?.enabled;\n    const srPanelMoveFocus = cardProps.modules?.srPanel?.moveFocus;\n\n    const riskEnabled = cardProps.modules?.risk?.enabled;\n\n    const billingAddressModeValue = cardProps.onAddressLookup ? 'lookup' : billingAddressMode;\n\n    let showKCPType: 'none' | 'auto' | 'atStart' = 'none';\n    if (configuration?.koreanAuthenticationRequired === true) {\n        showKCPType = countryCode?.toLowerCase() === 'kr' ? 'atStart' : 'auto';\n    }\n\n    // @ts-ignore commenting out props until endpoint is ready\n    const configData: CardConfigData = {\n        autoFocus,\n        ...(billingAddressAllowedCountries?.length > 0 && {\n            billingAddressAllowedCountries: billingAddressAllowedCountries.toString().substring(0, MAX_LENGTH)\n        }),\n        billingAddressMode: billingAddressModeValue,\n        billingAddressRequired,\n        billingAddressRequiredFields: billingAddressRequiredFields?.toString()?.substring(0, MAX_LENGTH),\n        // Probably just for development - in real life we wouldn't expect the number of supported brands to push the endpoint limit on 128 chars\n        brands: brands?.toString()?.substring(0, MAX_LENGTH),\n        challengeWindowSize,\n        disableIOSArrowKeys,\n        doBinLookup,\n        enableStoreDetails,\n        exposeExpiryDate,\n        forceCompat,\n        hasBrandsConfiguration: notFalsy(brandsConfiguration),\n        hasData: data && JSON.stringify(cardProps.data) !== dataString,\n        hasDisclaimerMessage: !!disclaimerMessage,\n        hasHolderName,\n        hasInstallmentOptions: notFalsy(installmentOptions),\n        hasPlaceholders: notFalsy(placeholders), // has merchant defined placeholders\n        hasStylesConfigured: notFalsy(styles),\n        hideCVC,\n        holderNameRequired,\n        keypadFix,\n        legacyInputMode,\n        maskSecurityCode,\n        minimumExpiryDate: !!minimumExpiryDate, // Potentially, in the future, we can send the actual string value\n        name,\n        positionHolderNameOnTop,\n        riskEnabled,\n        showBrandIcon,\n        showInstallmentAmounts: !!showInstallmentAmounts,\n        showKCPType,\n        showPayButton,\n        socialSecurityNumberMode: configuration?.socialSecurityNumberMode,\n        srPanelEnabled,\n        srPanelMoveFocus,\n        /** callbacks */\n        // We need to detect if the merchant themselves has defined these, not if we've set them as a default\n        hasOnAllValid: onAllValid !== CardInputDefaultProps.onAllValid,\n        hasOnBinValue: onBinValue !== CardInputDefaultProps.onBinValue,\n        hasOnBlur: onBlur !== CardInputDefaultProps.onBlur,\n        hasOnBrand: onBrand !== CardInputDefaultProps.onBrand,\n        hasOnConfigSuccess: onConfigSuccess !== CardInputDefaultProps.onConfigSuccess,\n        hasOnFieldValid: onFieldValid !== CardInputDefaultProps.onFieldValid,\n        hasOnFocus: onFocus !== CardInputDefaultProps.onFocus,\n        hasOnLoad: onLoad !== CardInputDefaultProps.onLoad,\n        // Card level props\n        hasOnBinLookup: !!onBinLookup,\n        hasOnEnterKeyPressed: !!onEnterKeyPressed\n    };\n\n    return configData;\n};\n"],"names":["getUTCTimestamp","Date","now","createAnalyticsObject","aObj","_object_spread","timestamp","String","component","id","uuid","event","code","errorType","message","type","ANALYTICS_ACTION_STR","THREEDS2_FULL","subType","subtype","result","target","issuer","isExpress","expressPage","isStoredPaymentMethod","brand","ANALYTICS_VALIDATION_ERROR_STR","validationErrorCode","mapErrorCodesForAnalytics","validationErrorMessage","configData","metadata","errorCode","errorCodeMapping","ERROR_FIELD_REQUIRED","ERROR_INVALID_FORMAT_EXPECTS","errCode","isNaN","Number","digitsOnlyFormatter","processAnalyticsData","analyticsData","Object","keys","reduce","acc","prop","ALLOWED_ANALYTICS_DATA","includes","getCardConfigData","cardProps","billingAddressRequiredFields","brands","autoFocus","billingAddressAllowedCountries","billingAddressMode","billingAddressRequired","DEFAULT_CARD_GROUP_TYPES","brandsConfiguration","challengeWindowSize","DEFAULT_CHALLENGE_WINDOW_SIZE","configuration","countryCode","data","disclaimerMessage","disableIOSArrowKeys","doBinLookup","enableStoreDetails","exposeExpiryDate","forceCompat","hasHolderName","hideCVC","holderNameRequired","installmentOptions","keypadFix","legacyInputMode","maskSecurityCode","minimumExpiryDate","name","placeholders","positionHolderNameOnTop","showBrandIcon","showInstallmentAmounts","showPayButton","styles","onAllValid","onBinLookup","onBinValue","onBlur","onBrand","onConfigSuccess","onEnterKeyPressed","onFieldValid","onFocus","onLoad","dataString","JSON","stringify","CardInputDefaultProps","srPanelEnabled","modules","srPanel","enabled","srPanelMoveFocus","moveFocus","riskEnabled","risk","billingAddressModeValue","onAddressLookup","showKCPType","koreanAuthenticationRequired","toLowerCase","_object_spread_props","length","toString","substring","hasBrandsConfiguration","notFalsy","hasData","hasDisclaimerMessage","hasInstallmentOptions","hasPlaceholders","hasStylesConfigured","socialSecurityNumberMode","hasOnAllValid","hasOnBinValue","hasOnBlur","hasOnBrand","hasOnConfigSuccess","hasOnFieldValid","hasOnFocus","hasOnLoad","hasOnBinLookup","hasOnEnterKeyPressed"],"mappings":"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"}